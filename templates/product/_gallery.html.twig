{% set productImages = product.images|default([]) %}
{# Uniformiser la taille de la thumbnail pour qu'elle corresponde aux autres images #}
{% set normalizedThumbnail = product.thumbnail|replace({'400': '800'}) %}
{% set allImages = [normalizedThumbnail] %}
{% if productImages|length > 0 %}
    {# Uniformiser toutes les images à la même taille #}
    {% set normalizedProductImages = [] %}
    {% for image in productImages %}
        {% set normalizedProductImages = normalizedProductImages|merge([image|replace({'400': '800'})]) %}
    {% endfor %}
    {% set allImages = allImages|merge(normalizedProductImages) %}
{% endif %}

{% if allImages|length > 0 %}
    <div
        data-controller="product-gallery"
        data-product-gallery-index-value="0"
        data-product-gallery-autoplay-value="{{ allImages|length > 1 ? 'true' : 'false' }}"
        data-product-gallery-interval-value="4000"
        aria-label="Galerie d'images du produit"
    >
        {# ===== LAYOUT DESKTOP ===== #}
        <div class="hidden lg:flex gap-4">
            {# Image principale (gauche) #}
            <div class="flex-1 relative group">
                <div
                    class="relative aspect-square bg-slate-800 rounded-xl overflow-hidden cursor-zoom-in"
{#                    data-action="mouseenter->product-gallery#handleZoom mousemove->product-gallery#handleZoom mouseleave->product-gallery#resetZoom click->product-gallery#openLightbox"#}
                    data-action="click->product-gallery#openLightbox"
                >
                    <img
                        data-product-gallery-target="mainImage"
                        src="{{ allImages[0] }}"
                        srcset="{{ allImages[0] }} 800w, {{ allImages[0]|replace({'800': '1200'}) }} 1200w"
                        sizes="(min-width: 1024px) 600px, 100vw"
                        alt="{{ allImages[0].alt|default(product.name) }}"
                        class="w-full h-full object-contain transition-all duration-200 ease-out"
                    >

                    {# Icône zoom #}
                    <div class="absolute bottom-4 right-4 bg-slate-900/80 backdrop-blur-sm rounded-full p-2
                            opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                        </svg>
                    </div>
                </div>

                {# Navigation flèches desktop #}
                {% if allImages|length > 1 %}
                    <button
                        type="button"
                        data-action="click->product-gallery#previous"
                        class="absolute left-3 top-1/2 -translate-y-1/2
                       bg-slate-900/80 backdrop-blur-sm hover:bg-slate-700
                       text-white rounded-full p-2.5
                       opacity-0 group-hover:opacity-100 hover:scale-110
                       transition-all duration-200"
                        aria-label="Image précédente"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button
                        type="button"
                        data-action="click->product-gallery#next"
                        class="absolute right-3 top-1/2 -translate-y-1/2
                       bg-slate-900/80 backdrop-blur-sm hover:bg-slate-700
                       text-white rounded-full p-2.5
                       opacity-0 group-hover:opacity-100 hover:scale-110
                       transition-all duration-200"
                        aria-label="Image suivante"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                {% endif %}
            </div>

            {# Colonne miniatures (droite) #}
            <div class="flex flex-col gap-2 w-28 shrink-0">
                <div class="flex flex-col gap-2 max-h-[500px] overflow-y-auto pr-1
                        [&::-webkit-scrollbar]:w-1.5
                        [&::-webkit-scrollbar-track]:bg-slate-800
                        [&::-webkit-scrollbar-track]:rounded-full
                        [&::-webkit-scrollbar-thumb]:bg-slate-600
                        [&::-webkit-scrollbar-thumb]:rounded-full
                        [&::-webkit-scrollbar-thumb]:hover:bg-slate-500">
                    {% for image in allImages %}
                        <button
                            type="button"
                            data-product-gallery-target="images"
                            data-action="click->product-gallery#select"
                            data-index="{{ loop.index0 }}"
                            data-full-src="{{ image }}"
                            data-srcset="{{ image }} 800w, {{ image|replace({'800': '1200'}) }} 1200w"
                            class="relative aspect-square rounded-lg overflow-hidden border-2 
                           {{ loop.first ? 'border-blue-500 opacity-100' : 'border-transparent hover:border-blue-400 opacity-60' }}
                           focus-visible:outline-2 focus-visible:outline-blue-500 focus-visible:outline-offset-2
                           transition-all duration-300 p-0"
                            aria-label="Voir l'image {{ loop.index }}"
                            aria-selected="{{ loop.first ? 'true' : 'false' }}"
                        >
                            <img
                                src="{{ image }}"
                                alt="{{ image.alt|default(product.name ~ ' - Image ' ~ loop.index) }}"
                                class="absolute inset-0 w-full h-full object-cover"
                                loading="{{ loop.index <= 4 ? 'eager' : 'lazy' }}"
                            >
                        </button>
                    {% endfor %}
                </div>

                {# Indicateur scroll si beaucoup d'images #}
                {% if allImages|length > 5 %}
                    <div class="text-center text-xs text-slate-400 mt-1">
                <span class="inline-flex items-center gap-1">
                    <svg class="w-3 h-3 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                    Scroll
                </span>
                    </div>
                {% endif %}
            </div>
        </div>

        {# ===== LAYOUT MOBILE/TABLETTE ===== #}
        <div class="lg:hidden">
            {# Carrousel principal #}
            <div class="relative group">
                <div class="aspect-square bg-slate-800 rounded-xl overflow-hidden">
                    <img
                        data-product-gallery-target="mainImage"
                        src="{{ allImages[0] }}"
                        srcset="{{ allImages[0] }} 800w, {{ allImages[0]|replace({'800': '1200'}) }} 1200w"
                        sizes="100vw"
                        alt="{{ allImages[0].alt|default(product.name) }}"
                        class="w-full h-full object-contain transition-opacity duration-150"
                        data-action="click->product-gallery#openLightbox"
                    >
                </div>

                {# Navigation flèches mobile #}
                {% if allImages|length > 1 %}
                    <button
                        type="button"
                        data-action="click->product-gallery#previous"
                        class="absolute left-2 top-1/2 -translate-y-1/2
                       bg-slate-900/80 backdrop-blur-sm text-white
                       rounded-full p-3 active:scale-95 transition-transform"
                        aria-label="Image précédente"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button
                        type="button"
                        data-action="click->product-gallery#next"
                        class="absolute right-2 top-1/2 -translate-y-1/2
                       bg-slate-900/80 backdrop-blur-sm text-white
                       rounded-full p-3 active:scale-95 transition-transform"
                        aria-label="Image suivante"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    {# Compteur mobile #}
                    <div
                        data-product-gallery-target="counter"
                        class="absolute bottom-4 left-1/2 -translate-x-1/2
                       bg-slate-900/80 backdrop-blur-sm text-white
                       text-sm font-medium px-3 py-1.5 rounded-full"
                    >
                        1 / {{ allImages|length }}
                    </div>
                {% endif %}
            </div>

            {# Miniatures horizontales mobile #}
            {% if allImages|length > 1 %}
                <div class="mt-3 flex gap-2 overflow-x-auto pb-2 snap-x snap-mandatory
                    [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
                    {% for image in allImages %}
                        <button
                            type="button"
                            data-product-gallery-target="images"
                            data-action="click->product-gallery#select"
                            data-index="{{ loop.index0 }}"
                            data-full-src="{{ image }}"
                            class="shrink-0 w-20 h-20 rounded-lg overflow-hidden snap-start border-2
                       {{ loop.first ? 'border-blue-500 opacity-100' : 'border-transparent opacity-60' }}
                       active:scale-95 transition-all duration-300 relative p-0"
                            aria-label="Voir l'image {{ loop.index }}"
                        >
                            <img
                                src="{{ image }}"
                                alt="{{ image.alt|default(product.name ~ ' - Image ' ~ loop.index) }}"
                                class="absolute inset-0 w-full h-full object-cover"
                                loading="lazy"
                            >
                        </button>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        {# ===== LIGHTBOX ===== #}
        <div
            data-product-gallery-target="lightbox"
            class="hidden fixed inset-0 z-50 bg-black/95 items-center justify-center
               animate-[fadeIn_200ms_ease-out]"
            role="dialog"
            aria-modal="true"
            aria-label="Zoom image"
            tabindex="-1"
        >
            {# Bouton fermer #}
            <button
                type="button"
                data-action="click->product-gallery#closeLightbox"
                class="absolute top-4 right-4 text-white/80 hover:text-white
                   transition-colors z-10 p-2 rounded-full hover:bg-white/10"
                aria-label="Fermer"
            >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            {# Image lightbox #}
            <div class="relative max-w-[90vw] max-h-[90vh]">
                <img
                    data-product-gallery-target="lightboxImage"
                    src="{{ allImages[0] }}"
                    alt="{{ allImages[0].alt|default(product.name) }}"
                    class="max-w-full max-h-[90vh] object-contain"
                >
            </div>

            {# Navigation lightbox #}
            {% if allImages|length > 1 %}
                <button
                    type="button"
                    data-action="click->product-gallery#previous"
                    class="absolute left-4 top-1/2 -translate-y-1/2
                   bg-white/10 hover:bg-white/20 text-white
                   rounded-full p-3 transition-colors"
                    aria-label="Image précédente"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button
                    type="button"
                    data-action="click->product-gallery#next"
                    class="absolute right-4 top-1/2 -translate-y-1/2
                   bg-white/10 hover:bg-white/20 text-white
                   rounded-full p-3 transition-colors"
                    aria-label="Image suivante"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                {# Compteur lightbox #}
                <div
                    data-product-gallery-target="counter"
                    class="absolute bottom-6 left-1/2 -translate-x-1/2
                   text-white/80 text-sm font-medium"
                >
                    1 / {{ allImages|length }}
                </div>
            {% endif %}

            {# Fermer en cliquant sur le fond #}
            <div
                data-action="click->product-gallery#closeLightbox"
                class="absolute inset-0 -z-10"
            ></div>
        </div>
    </div>
{% else %}
    {# Placeholder si pas d'images #}
    <div class="aspect-square bg-slate-800 rounded-xl flex items-center justify-center">
        <div class="text-center text-slate-500">
            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p>Aucune image disponible</p>
        </div>
    </div>
{% endif %}
