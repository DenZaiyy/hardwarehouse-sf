name: Quality Analysis
on:
    workflow_call:
jobs:
    quality:
        name: Quality Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.4
                  tools: composer:v2

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: /tmp/composer-cache
                  key: ${{ runner.os }}-composer-quality-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-quality-
                      ${{ runner.os }}-composer-

            - name: Update composer
              run: composer self-update

            - name: Install dependencies
              run: |
                  composer config cache-dir /tmp/composer-cache
                  composer install --no-interaction --no-progress --optimize-autoloader

            - name: Quality Analysis
              run: |
                  # Cr√©er dossiers pour rapports
                  mkdir -p /tmp/quality-reports

                  # Variables pour tracking des erreurs
                  ERRORS=0

                  # Ex√©cuter ECS avec rapport (continue si √©chec)
                  echo "üîç Running ECS..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php ./vendor/bin/ecs check --fix --output-format=json > /tmp/quality-reports/ecs-report.json 2>&1; then
                      echo "‚ùå ECS failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # Ex√©cuter Rector avec rapport (continue si √©chec)
                  echo "üîß Running Rector..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php ./vendor/bin/rector --dry-run --output-format=json > /tmp/quality-reports/rector-report.json 2>&1; then
                      echo "‚ùå Rector failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # Lint YAML (continue si √©chec)
                  echo "üìù Linting YAML..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php bin/console lint:yaml config --parse-tags 2>&1 | tee -a /tmp/quality-reports/yaml-lint.log; then
                      echo "‚ùå YAML lint failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # Lint Twig (continue si √©chec)
                  echo "üé® Linting Twig..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php bin/console lint:twig templates 2>&1 | tee -a /tmp/quality-reports/twig-lint.log; then
                      echo "‚ùå Twig lint failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # Lint Container (continue si √©chec)
                  echo "üèóÔ∏è Linting Container..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php bin/console lint:container 2>&1 | tee -a /tmp/quality-reports/container-lint.log; then
                      echo "‚ùå Container lint failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # PHPStan avec rapport JSON (continue si √©chec)
                  echo "üß™ Running PHPStan..." | tee -a /tmp/quality-reports/quality-output.log
                  if ! php ./vendor/bin/phpstan analyse --memory-limit=-1 --level max --error-format=json > /tmp/quality-reports/phpstan-report.json 2>&1; then
                      echo "‚ùå PHPStan failed" | tee -a /tmp/quality-reports/quality-output.log
                      ERRORS=$((ERRORS + 1))
                  fi

                  # Rapport final avec codes de sortie
                  echo "Total errors found: $ERRORS" | tee -a /tmp/quality-reports/quality-output.log

                  if [ $ERRORS -gt 0 ]; then
                      echo "‚ùå Quality analysis completed with $ERRORS error(s)" | tee -a /tmp/quality-reports/quality-output.log
                      exit 1
                  else
                      echo "‚úÖ Quality analysis completed successfully" | tee -a /tmp/quality-reports/quality-output.log
                  fi

            - name: Upload quality reports
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: quality-reports-${{ github.run_number }}
                  path: |
                      /tmp/quality-reports/
                  retention-days: 30

            - name: Upload PHPStan cache (for analysis)
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: phpstan-cache-${{ github.run_number }}
                  path: |
                      var/cache/phpstan/
                      .phpstan.cache
                  retention-days: 7
