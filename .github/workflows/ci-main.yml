name: CI Main Pipeline
on:
    push:
        branches:
            - main

permissions:
    contents: read
    actions: read

concurrency:
    group: production-deployment
    cancel-in-progress: false

jobs:
    # Re-teste tout sur main pour sÃ©curitÃ© maximale avec cache optimisÃ©
    audit:
        uses: ./.github/workflows/audit.yml

    quality:
        uses: ./.github/workflows/quality.yml

    tests:
        uses: ./.github/workflows/test.yml

    # DÃ©ploie en production avec optimisations
    deploy-production:
        name: Deploy to Production
        needs: [audit, quality, tests]
        runs-on: ubuntu-latest
        environment: prod
        timeout-minutes: 15
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 1

            - name: Setup PHP (pour validation locale)
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: ctype, iconv, json, mbstring, pdo_mysql
                  tools: composer:v2
                  coverage: none

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: /tmp/composer-cache
                  key: ${{ runner.os }}-composer-prod-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-prod-
                      ${{ runner.os }}-composer-

            - name: Validate deployment readiness
              run: |
                  composer validate --strict
                  composer install --no-dev --optimize-autoloader --no-interaction --dry-run

            - name: Deploy to production server
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  port: ${{ secrets.PORT }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  password: ${{ secrets.SSH_PASSWORD }}
                  timeout: 300s
                  script_stop: true
                  script: |
                      set -e
                      echo "ğŸš€ Starting production deployment..."

                      # Variables
                      PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
                      BACKUP_DIR="$HOME/backups/hardwarehouse"
                      TIMESTAMP=$(date +%Y%m%d_%H%M%S)

                      # Backup current version
                      echo "ğŸ“¦ Creating backup..."
                      mkdir -p $BACKUP_DIR
                      cp -r $PROJECT_PATH $BACKUP_DIR/backup-$TIMESTAMP || true

                      # Navigate to project
                      cd $PROJECT_PATH

                      # Maintenance mode
                      echo "ğŸ”§ Enabling maintenance mode..."
                      touch var/maintenance.flag || true

                      # Update code
                      echo "ğŸ“¥ Fetching latest code..."
                      git fetch origin --prune
                      git reset --hard origin/main

                      # Build, install and deploy
                      echo "ğŸ“¦ Running production build..."
                      make prod

                      # Disable maintenance mode
                      echo "âœ… Disabling maintenance mode..."
                      rm -f var/maintenance.flag || true

                      # Health check
                      echo "ğŸ©º Running health check..."
                      php bin/console about --env=prod > /dev/null

                      echo "ğŸ‰ Production deployment completed successfully!"
                      echo "ğŸ“‹ Backup location: $BACKUP_DIR/backup-$TIMESTAMP"

            - name: Notify deployment status
              if: always()
              run: |
                  if [ "${{ job.status }}" == "success" ]; then
                      echo "âœ… Deployment successful"
                  else
                      echo "âŒ Deployment failed"
                      exit 1
                  fi
